# ==============================================================================
# OOTS EMREX Logstash Pipeline - Structured JSON Logging
# ==============================================================================
#
# Purpose:
#   Processes OOTS log events that already contain structured oots.* fields
#   extracted by the application. No XML parsing needed - just pass-through
#   with optional enrichment.
#
# ==============================================================================

input {
  file {
    path => "/testdata/raw_logs.ndjson"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json"
    mode => "read"
    file_completed_action => "log"
    file_completed_log_path => "/tmp/completed_files.log"
    stat_interval => 1
    discover_interval => 1
  }
}

filter {
  # Only process OOTS logger events
  if [logger] == "OOTS" {

    # -------------------------------------------------------------------------
    # Extract oots.* fields from log object to top level
    # -------------------------------------------------------------------------
    if [log][oots] {
      ruby {
        code => '
          oots_data = event.get("[log][oots]")
          if oots_data.is_a?(Hash)
            oots_data.each do |key, value|
              event.set("[oots][#{key}]", value)
            end
          end
        '
      }
    }

    # -------------------------------------------------------------------------
    # Set ECS (Elastic Common Schema) fields
    # -------------------------------------------------------------------------
    if [oots][request_time] {
      mutate { add_field => { "[event][created]" => "%{[oots][request_time]}" } }
    } else if [oots][response_issue_time] {
      mutate { add_field => { "[event][created]" => "%{[oots][response_issue_time]}" } }
    }

    if [oots][event][created] {
      mutate { replace => { "[event][created]" => "%{[oots][event][created]}" } }
    }

    if [oots][error] {
      if [oots][error][exception_code] {
        mutate { add_field => { "[error][code]" => "%{[oots][error][exception_code]}" } }
      }
      if [oots][error][exception_message] {
        mutate { add_field => { "[error][message]" => "%{[oots][error][exception_message]}" } }
      }
      if [oots][error][exception_type] {
        mutate { add_field => { "[error][type]" => "%{[oots][error][exception_type]}" } }
      }
    }

    # -------------------------------------------------------------------------
    # Determine message type and set event.action
    # -------------------------------------------------------------------------
    if [oots][request_id] and ![oots][response_id] {
      mutate { add_field => { "[oots][message_type]" => "request" } }
      mutate { add_field => { "[event][action]" => "evidence-request" } }
    } else if [oots][response_id] {
      mutate { add_field => { "[oots][message_type]" => "response" } }
      mutate { add_field => { "[event][action]" => "evidence-response" } }
    }

    # -------------------------------------------------------------------------
    # Extract emrex.* fields from log object
    # -------------------------------------------------------------------------
    if [log][conversationId] {
      mutate { add_field => { "[emrex][conversationid]" => "%{[log][conversationId]}" } }
    }
    if [log][messageId] {
      mutate { add_field => { "[emrex][messageid]" => "%{[log][messageId]}" } }
    }
    if [log][evidenceRequestId] {
      mutate { add_field => { "[emrex][evidence_request_id]" => "%{[log][evidenceRequestId]}" } }
    }

    # -------------------------------------------------------------------------
    # Set event.outcome based on result
    # -------------------------------------------------------------------------
    if [oots][result] == "Evidence delivered" {
      mutate { add_field => { "[event][outcome]" => "success" } }
      mutate { add_field => { "[event][reason]" => "Evidence delivered" } }
    } else if [oots][result] == "No evidence delivered" {
      mutate { add_field => { "[event][outcome]" => "success" } }
      mutate { add_field => { "[event][reason]" => "No evidence delivered" } }
    } else if [oots][result] == "Preview requested" {
      mutate { add_field => { "[event][outcome]" => "unknown" } }
      mutate { add_field => { "[event][reason]" => "Preview requested" } }
    } else if [oots][result] == "Error" {
      mutate { add_field => { "[event][outcome]" => "failure" } }
      mutate { add_field => { "[event][reason]" => "Error" } }
    } else if [oots][message_type] == "request" {
      mutate { add_field => { "[event][outcome]" => "unknown" } }
    }

    # -------------------------------------------------------------------------
    # Clean up nested fields that can cause Elasticsearch mapping conflicts
    # -------------------------------------------------------------------------
    mutate {
      remove_field => [
        "[log][errorReport]",
        "[log][subject]",
        "[log][nonRepudiationInformation]"
      ]
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "oots-structured-logs-%{+YYYY.MM.dd}"
  }

  stdout {
    codec => rubydebug { metadata => false }
  }
}
